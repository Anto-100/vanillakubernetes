---
- name: Install Vanilla Kubernetes (kubectl + minikube) on Ubuntu
  hosts: all
  become: yes  # Start with root for installations
  gather_facts: yes

  tasks:
    # Verify user is not root for minikube operations
    - name: Check current user
      shell: whoami
      register: current_user
      changed_when: false

    - name: Verify Docker is installed and running
      shell: docker --version && systemctl is-active docker
      register: docker_check
      failed_when: docker_check.rc != 0

    - name: Verify user is in docker group
      shell: groups {{ k8s_user }} | grep docker
      register: docker_group_check
      failed_when: docker_group_check.rc != 0
      ignore_errors: yes

    - name: Fail if user not in docker group
      fail:
        msg: "User {{ k8s_user }} is not in docker group. Please run Docker installation first or add user to docker group and ensure they have logged out/in."
      when: docker_group_check.rc != 0

    # Install kubectl (as root)
    - name: Download latest stable kubectl version info
      uri:
        url: https://dl.k8s.io/release/stable.txt
        return_content: yes
      register: kubectl_latest_version

    - name: Download latest stable kubectl binary
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_latest_version.content | trim }}/bin/linux/amd64/kubectl"
        dest: /tmp/kubectl
        mode: '0755'

    - name: Move kubectl to system PATH
      copy:
        src: /tmp/kubectl
        dest: /usr/local/bin/kubectl
        mode: '0755'
        remote_src: yes

    # Install minikube (as root)
    - name: Download latest minikube
      get_url:
        url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        dest: /tmp/minikube
        mode: '0755'

    - name: Move minikube to system PATH
      copy:
        src: /tmp/minikube
        dest: /usr/local/bin/minikube
        mode: '0755'
        remote_src: yes

    # Now switch to regular user for minikube operations
    - name: Start minikube cluster with Docker driver (as regular user)
      shell: minikube start --driver=docker
      become: no
      become_user: "{{ k8s_user }}"
      register: minikube_start_output
      timeout: 600
      when: start_cluster == "yes"

    # Setup .kube directory (as regular user)
    - name: Create .kube directory
      file:
        path: "/home/{{ k8s_user }}/.kube"
        state: directory
        mode: '0755'
        owner: "{{ k8s_user }}"
        group: "{{ k8s_user }}"

    - name: Update kubectl context (as regular user)
      shell: minikube update-context
      become: no
      become_user: "{{ k8s_user }}"
      when: start_cluster == "yes"

    - name: Display completion message
      debug:
        msg: |
          🎉 Vanilla Kubernetes Installation Complete!
          ✅ kubectl: Installed
          ✅ minikube: Installed
          {% if start_cluster == "yes" %}
          ✅ Kubernetes Cluster: Running as user {{ k8s_user }}
          ✅ kubectl config: Configured in /home/{{ k8s_user }}/.kube/
          {% else %}
          ⏸️  Kubernetes Cluster: Ready to start
          {% endif %}
          
          🚀 To use Kubernetes:
          1. Switch to user: sudo su - {{ k8s_user }}
          2. Check cluster: kubectl get nodes
          3. Cluster info: kubectl cluster-info