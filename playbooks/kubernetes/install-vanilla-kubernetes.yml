---
- name: Install Vanilla Kubernetes (kubectl + minikube) on Ubuntu
  hosts: all
  become: no
  gather_facts: yes
  vars:
    k8s_user: "{{ ansible_user }}"  # Use the current SSH user, not root

  tasks:
    - name: Fail if running as root user
      fail:
        msg: "minikube should not be run as root user. Please run this playbook with a non-root user (like admin1)."
      when: ansible_user == "root"

    - name: Check if user is in docker group
      shell: groups {{ k8s_user }} | grep docker
      register: docker_group_check
      failed_when: false
      changed_when: false

    - name: Fail if user not in docker group
      fail:
        msg: "User {{ k8s_user }} is not in docker group. Please add user to docker group and re-login."
      when: docker_group_check.rc != 0

    - name: Verify Docker is accessible by current user
      shell: docker ps
      register: docker_access_check
      failed_when: docker_access_check.rc != 0

    # Install kubectl
    - name: Download latest stable kubectl version info
      uri:
        url: https://dl.k8s.io/release/stable.txt
        return_content: yes
      register: kubectl_latest_version

    - name: Download latest stable kubectl binary
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_latest_version.content | trim }}/bin/linux/amd64/kubectl"
        dest: /tmp/kubectl
        mode: '0755'

    - name: Move kubectl to system PATH
      copy:
        src: /tmp/kubectl
        dest: /usr/local/bin/kubectl
        mode: '0755'
        remote_src: yes
      become: yes

    # Install minikube
    - name: Download latest minikube
      get_url:
        url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        dest: /tmp/minikube
        mode: '0755'

    - name: Move minikube to system PATH
      copy:
        src: /tmp/minikube
        dest: /usr/local/bin/minikube
        mode: '0755'
        remote_src: yes
      become: yes

    # Start Kubernetes Cluster
    - name: Start minikube cluster with Docker driver
      shell: minikube start --driver=docker
      timeout: 600
      when: start_cluster == "yes"

    # Setup .kube directory
    - name: Create .kube directory
      file:
        path: "~/.kube"
        state: directory
        mode: '0755'

    - name: Update kubectl context
      shell: minikube update-context
      when: start_cluster == "yes"